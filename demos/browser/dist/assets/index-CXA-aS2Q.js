(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const _ of o)if(_.type==="childList")for(const c of _.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const _={};return o.integrity&&(_.integrity=o.integrity),o.referrerPolicy&&(_.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?_.credentials="include":o.crossOrigin==="anonymous"?_.credentials="omit":_.credentials="same-origin",_}function r(o){if(o.ep)return;o.ep=!0;const _=n(o);fetch(o.href,_)}})();let i;function ue(t){const e=i.__externref_table_alloc();return i.__wbindgen_externrefs.set(e,t),e}function H(t){const e=typeof t;if(e=="number"||e=="boolean"||t==null)return`${t}`;if(e=="string")return`"${t}"`;if(e=="symbol"){const o=t.description;return o==null?"Symbol":`Symbol(${o})`}if(e=="function"){const o=t.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(t)){const o=t.length;let _="[";o>0&&(_+=H(t[0]));for(let c=1;c<o;c++)_+=", "+H(t[c]);return _+="]",_}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(n&&n.length>1)r=n[1];else return toString.call(t);if(r=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:r}function le(t,e){return t=t>>>0,de().subarray(t/8,t/8+e)}function fe(t,e){return t=t>>>0,R().subarray(t/1,t/1+e)}let q=null;function w(){return(q===null||q.buffer.detached===!0||q.buffer.detached===void 0&&q.buffer!==i.memory.buffer)&&(q=new DataView(i.memory.buffer)),q}let I=null;function de(){return(I===null||I.byteLength===0)&&(I=new Float64Array(i.memory.buffer)),I}function O(t,e){return t=t>>>0,be(t,e)}let B=null;function R(){return(B===null||B.byteLength===0)&&(B=new Uint8Array(i.memory.buffer)),B}function x(t,e){try{return t.apply(this,e)}catch(n){const r=ue(n);i.__wbindgen_exn_store(r)}}function S(t){return t==null}function d(t,e,n){if(n===void 0){const s=F.encode(t),l=e(s.length,1)>>>0;return R().subarray(l,l+s.length).set(s),f=s.length,l}let r=t.length,o=e(r,1)>>>0;const _=R();let c=0;for(;c<r;c++){const s=t.charCodeAt(c);if(s>127)break;_[o+c]=s}if(c!==r){c!==0&&(t=t.slice(c)),o=n(o,r,r=c+t.length*3,1)>>>0;const s=R().subarray(o+c,o+r),l=F.encodeInto(t,s);c+=l.written,o=n(o,r,c,1)>>>0}return f=c,o}function a(t){const e=i.__wbindgen_externrefs.get(t);return i.__externref_table_dealloc(t),e}let W=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});W.decode();const ge=2146435072;let U=0;function be(t,e){return U+=e,U>=ge&&(W=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),W.decode(),U=e),W.decode(R().subarray(t,t+e))}const F=new TextEncoder;"encodeInto"in F||(F.encodeInto=function(t,e){const n=F.encode(t);return e.set(n),{read:t.length,written:n.length}});let f=0;const Q=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>i.__wbg_quiverengine_free(t>>>0,1));typeof FinalizationRegistry>"u"||new FinalizationRegistry(t=>i.__wbg_quivererror_free(t>>>0,1));class J{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Q.unregister(this),e}free(){const e=this.__destroy_into_raw();i.__wbg_quiverengine_free(e,0)}constructor(e){const n=i.quiverengine_new(e);return this.__wbg_ptr=n>>>0,Q.register(this,this.__wbg_ptr,this),this}get sample_rate(){return i.quiverengine_sample_rate(this.__wbg_ptr)}get_catalog(){const e=i.quiverengine_get_catalog(this.__wbg_ptr);if(e[2])throw a(e[1]);return a(e[0])}search_modules(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_search_modules(this.__wbg_ptr,n,r);if(o[2])throw a(o[1]);return a(o[0])}get_modules_by_category(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_get_modules_by_category(this.__wbg_ptr,n,r);if(o[2])throw a(o[1]);return a(o[0])}get_categories(){const e=i.quiverengine_get_categories(this.__wbg_ptr);if(e[2])throw a(e[1]);return a(e[0])}get_signal_colors(){const e=i.quiverengine_get_signal_colors(this.__wbg_ptr);if(e[2])throw a(e[1]);return a(e[0])}check_compatibility(e,n){const r=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),o=f,_=d(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=f,s=i.quiverengine_check_compatibility(this.__wbg_ptr,r,o,_,c);if(s[2])throw a(s[1]);return a(s[0])}load_patch(e){const n=i.quiverengine_load_patch(this.__wbg_ptr,e);if(n[1])throw a(n[0])}save_patch(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_save_patch(this.__wbg_ptr,n,r);if(o[2])throw a(o[1]);return a(o[0])}validate_patch(e){const n=i.quiverengine_validate_patch(this.__wbg_ptr,e);if(n[2])throw a(n[1]);return a(n[0])}clear_patch(){i.quiverengine_clear_patch(this.__wbg_ptr)}add_module(e,n){const r=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),o=f,_=d(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=f,s=i.quiverengine_add_module(this.__wbg_ptr,r,o,_,c);if(s[1])throw a(s[0])}remove_module(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_remove_module(this.__wbg_ptr,n,r);if(o[1])throw a(o[0])}set_module_position(e,n,r){const o=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),_=f,c=i.quiverengine_set_module_position(this.__wbg_ptr,o,_,n,r);if(c[1])throw a(c[0])}get_module_position(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_get_module_position(this.__wbg_ptr,n,r);if(o[2])throw a(o[1]);return a(o[0])}module_count(){return i.quiverengine_module_count(this.__wbg_ptr)>>>0}cable_count(){return i.quiverengine_cable_count(this.__wbg_ptr)>>>0}set_output(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_set_output(this.__wbg_ptr,n,r);if(o[1])throw a(o[0])}connect(e,n){const r=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),o=f,_=d(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=f,s=i.quiverengine_connect(this.__wbg_ptr,r,o,_,c);if(s[1])throw a(s[0])}connect_attenuated(e,n,r){const o=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),_=f,c=d(n,i.__wbindgen_malloc,i.__wbindgen_realloc),s=f,l=i.quiverengine_connect_attenuated(this.__wbg_ptr,o,_,c,s,r);if(l[1])throw a(l[0])}connect_modulated(e,n,r,o){const _=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),c=f,s=d(n,i.__wbindgen_malloc,i.__wbindgen_realloc),l=f,g=i.quiverengine_connect_modulated(this.__wbg_ptr,_,c,s,l,r,o);if(g[1])throw a(g[0])}disconnect_by_index(e){const n=i.quiverengine_disconnect_by_index(this.__wbg_ptr,e);if(n[1])throw a(n[0])}disconnect(e,n){const r=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),o=f,_=d(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=f,s=i.quiverengine_disconnect(this.__wbg_ptr,r,o,_,c);if(s[1])throw a(s[0])}get_module_names(){const e=i.quiverengine_get_module_names(this.__wbg_ptr);if(e[2])throw a(e[1]);return a(e[0])}get_params(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_get_params(this.__wbg_ptr,n,r);if(o[2])throw a(o[1]);return a(o[0])}set_param(e,n,r){const o=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),_=f,c=i.quiverengine_set_param(this.__wbg_ptr,o,_,n,r);if(c[1])throw a(c[0])}get_param(e,n){const r=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),o=f,_=i.quiverengine_get_param(this.__wbg_ptr,r,o,n);if(_[2])throw a(_[1]);return _[0]}set_param_by_name(e,n,r){const o=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),_=f,c=d(n,i.__wbindgen_malloc,i.__wbindgen_realloc),s=f,l=i.quiverengine_set_param_by_name(this.__wbg_ptr,o,_,c,s,r);if(l[1])throw a(l[0])}subscribe(e){const n=i.quiverengine_subscribe(this.__wbg_ptr,e);if(n[1])throw a(n[0])}unsubscribe(e){const n=i.quiverengine_unsubscribe(this.__wbg_ptr,e);if(n[1])throw a(n[0])}clear_subscriptions(){i.quiverengine_clear_subscriptions(this.__wbg_ptr)}poll_updates(){const e=i.quiverengine_poll_updates(this.__wbg_ptr);if(e[2])throw a(e[1]);return a(e[0])}pending_update_count(){return i.quiverengine_pending_update_count(this.__wbg_ptr)>>>0}tick(){const e=i.quiverengine_tick(this.__wbg_ptr);var n=le(e[0],e[1]).slice();return i.__wbindgen_free(e[0],e[1]*8,8),n}process_block(e){return i.quiverengine_process_block(this.__wbg_ptr,e)}reset(){i.quiverengine_reset(this.__wbg_ptr)}compile(){const e=i.quiverengine_compile(this.__wbg_ptr);if(e[1])throw a(e[0])}midi_note_on(e,n){const r=i.quiverengine_midi_note_on(this.__wbg_ptr,e,n);if(r[1])throw a(r[0])}midi_note_off(e,n){const r=i.quiverengine_midi_note_off(this.__wbg_ptr,e,n);if(r[1])throw a(r[0])}get midi_note(){return i.quiverengine_midi_note(this.__wbg_ptr)}get midi_velocity(){return i.quiverengine_midi_velocity(this.__wbg_ptr)}get midi_gate(){return i.quiverengine_midi_gate(this.__wbg_ptr)!==0}midi_cc(e,n){const r=i.quiverengine_midi_cc(this.__wbg_ptr,e,n);if(r[1])throw a(r[0])}get_midi_cc(e){return i.quiverengine_get_midi_cc(this.__wbg_ptr,e)}midi_pitch_bend(e){const n=i.quiverengine_midi_pitch_bend(this.__wbg_ptr,e);if(n[1])throw a(n[0])}get pitch_bend(){return i.quiverengine_pitch_bend(this.__wbg_ptr)}get_port_spec(e){const n=d(e,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,o=i.quiverengine_get_port_spec(this.__wbg_ptr,n,r);if(o[2])throw a(o[1]);return a(o[0])}}Symbol.dispose&&(J.prototype[Symbol.dispose]=J.prototype.free);const we=new Set(["basic","cors","default"]);async function pe(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.ok&&we.has(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function me(){const t={};return t.wbg={},t.wbg.__wbg_Error_52673b7de5a0ca89=function(e,n){return Error(O(e,n))},t.wbg.__wbg_Number_2d1dcfcf4ec51736=function(e){return Number(e)},t.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,n){const r=String(n),o=d(r,i.__wbindgen_malloc,i.__wbindgen_realloc),_=f;w().setInt32(e+4*1,_,!0),w().setInt32(e+4*0,o,!0)},t.wbg.__wbg___wbindgen_bigint_get_as_i64_6e32f5e6aff02e1d=function(e,n){const r=n,o=typeof r=="bigint"?r:void 0;w().setBigInt64(e+8*1,S(o)?BigInt(0):o,!0),w().setInt32(e+4*0,!S(o),!0)},t.wbg.__wbg___wbindgen_boolean_get_dea25b33882b895b=function(e){const n=e,r=typeof n=="boolean"?n:void 0;return S(r)?16777215:r?1:0},t.wbg.__wbg___wbindgen_debug_string_adfb662ae34724b6=function(e,n){const r=H(n),o=d(r,i.__wbindgen_malloc,i.__wbindgen_realloc),_=f;w().setInt32(e+4*1,_,!0),w().setInt32(e+4*0,o,!0)},t.wbg.__wbg___wbindgen_in_0d3e1e8f0c669317=function(e,n){return e in n},t.wbg.__wbg___wbindgen_is_bigint_0e1a2e3f55cfae27=function(e){return typeof e=="bigint"},t.wbg.__wbg___wbindgen_is_function_8d400b8b1af978cd=function(e){return typeof e=="function"},t.wbg.__wbg___wbindgen_is_object_ce774f3490692386=function(e){const n=e;return typeof n=="object"&&n!==null},t.wbg.__wbg___wbindgen_is_string_704ef9c8fc131030=function(e){return typeof e=="string"},t.wbg.__wbg___wbindgen_is_undefined_f6b95eab589e0269=function(e){return e===void 0},t.wbg.__wbg___wbindgen_jsval_eq_b6101cc9cef1fe36=function(e,n){return e===n},t.wbg.__wbg___wbindgen_jsval_loose_eq_766057600fdd1b0d=function(e,n){return e==n},t.wbg.__wbg___wbindgen_number_get_9619185a74197f95=function(e,n){const r=n,o=typeof r=="number"?r:void 0;w().setFloat64(e+8*1,S(o)?0:o,!0),w().setInt32(e+4*0,!S(o),!0)},t.wbg.__wbg___wbindgen_string_get_a2a31e16edf96e42=function(e,n){const r=n,o=typeof r=="string"?r:void 0;var _=S(o)?0:d(o,i.__wbindgen_malloc,i.__wbindgen_realloc),c=f;w().setInt32(e+4*1,c,!0),w().setInt32(e+4*0,_,!0)},t.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(e,n){throw new Error(O(e,n))},t.wbg.__wbg_call_abb4ff46ce38be40=function(){return x(function(e,n){return e.call(n)},arguments)},t.wbg.__wbg_done_62ea16af4ce34b24=function(e){return e.done},t.wbg.__wbg_entries_83c79938054e065f=function(e){return Object.entries(e)},t.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,n){let r,o;try{r=e,o=n,console.error(O(e,n))}finally{i.__wbindgen_free(r,o,1)}},t.wbg.__wbg_get_6b7bd52aca3f9671=function(e,n){return e[n>>>0]},t.wbg.__wbg_get_af9dab7e9603ea93=function(){return x(function(e,n){return Reflect.get(e,n)},arguments)},t.wbg.__wbg_get_with_ref_key_1dc361bd10053bfe=function(e,n){return e[n]},t.wbg.__wbg_instanceof_ArrayBuffer_f3320d2419cd0355=function(e){let n;try{n=e instanceof ArrayBuffer}catch{n=!1}return n},t.wbg.__wbg_instanceof_Map_084be8da74364158=function(e){let n;try{n=e instanceof Map}catch{n=!1}return n},t.wbg.__wbg_instanceof_Uint8Array_da54ccc9d3e09434=function(e){let n;try{n=e instanceof Uint8Array}catch{n=!1}return n},t.wbg.__wbg_isArray_51fd9e6422c0a395=function(e){return Array.isArray(e)},t.wbg.__wbg_isSafeInteger_ae7d3f054d55fa16=function(e){return Number.isSafeInteger(e)},t.wbg.__wbg_iterator_27b7c8b35ab3e86b=function(){return Symbol.iterator},t.wbg.__wbg_length_22ac23eaec9d8053=function(e){return e.length},t.wbg.__wbg_length_d45040a40c570362=function(e){return e.length},t.wbg.__wbg_new_1ba21ce319a06297=function(){return new Object},t.wbg.__wbg_new_25f239778d6112b9=function(){return new Array},t.wbg.__wbg_new_6421f6084cc5bc5a=function(e){return new Uint8Array(e)},t.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},t.wbg.__wbg_new_b546ae120718850e=function(){return new Map},t.wbg.__wbg_new_with_length_95ba657dfb7d3dfb=function(e){return new Float32Array(e>>>0)},t.wbg.__wbg_next_138a17bbf04e926c=function(e){return e.next},t.wbg.__wbg_next_3cfe5c0fe2a4cc53=function(){return x(function(e){return e.next()},arguments)},t.wbg.__wbg_prototypesetcall_dfe9b766cdc1f1fd=function(e,n,r){Uint8Array.prototype.set.call(fe(e,n),r)},t.wbg.__wbg_set_3f1d0b984ed272ed=function(e,n,r){e[n]=r},t.wbg.__wbg_set_7df433eea03a5c14=function(e,n,r){e[n>>>0]=r},t.wbg.__wbg_set_efaaf145b9377369=function(e,n,r){return e.set(n,r)},t.wbg.__wbg_set_index_165b46b0114d368c=function(e,n,r){e[n>>>0]=r},t.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,n){const r=n.stack,o=d(r,i.__wbindgen_malloc,i.__wbindgen_realloc),_=f;w().setInt32(e+4*1,_,!0),w().setInt32(e+4*0,o,!0)},t.wbg.__wbg_value_57b7b035e117f7ee=function(e){return e.value},t.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,n){return O(e,n)},t.wbg.__wbindgen_cast_4625c577ab2ec9ee=function(e){return BigInt.asUintN(64,e)},t.wbg.__wbindgen_cast_9ae0607507abb057=function(e){return e},t.wbg.__wbindgen_cast_d6cd19b81560fd6e=function(e){return e},t.wbg.__wbindgen_init_externref_table=function(){const e=i.__wbindgen_externrefs,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t}function he(t,e){return i=t.exports,re.__wbindgen_wasm_module=e,q=null,I=null,B=null,i.__wbindgen_start(),i}async function re(t){if(i!==void 0)return i;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL("/assets/quiver_bg-BJ6gK5Oc.wasm",import.meta.url));const e=me();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await pe(await t,e);return he(n,r)}const M=4,oe=256;let u=null,h=null,X=null,y=null,K=!1,G="saw",ie="scope",C=[],E=new Map,p=new Float32Array(512),se=new Float32Array(512),$=0,N=0,D=0,Y=.95,P=new Uint8Array(oe/2);const Z={saw:"saw",pulse:"sqr",tri:"tri",sine:"sin"};function ye(t){for(const e of C)if(!e.active)return e.index;return 0}function ve(t){if(!u||t===G)return;const e=Z[G],n=Z[t];if(!(!e||!n))try{for(let r=0;r<M;r++)u.disconnect(`osc_${r}.${e}`,`filter_${r}.in`),u.connect(`osc_${r}.${n}`,`filter_${r}.in`);u.compile(),G=t}catch(r){console.error("Failed to switch waveform:",r)}}const v=document.getElementById("status"),j=document.getElementById("start"),L=document.getElementById("scope"),T=document.getElementById("spectrum"),A=L.getContext("2d"),z=T.getContext("2d");function V(t,e){const n=t.getBoundingClientRect(),r=window.devicePixelRatio||1;return t.width=n.width*r,t.height=n.height*r,e.scale(r,r),{width:n.width,height:n.height}}async function ke(){try{await re(),v.className="ready",v.textContent="Ready // Click to Initialize",j.disabled=!1}catch(t){v.className="error",v.textContent=`WASM Error: ${t.message}`,console.error("WASM init failed:",t)}}function qe(t){const e=(s,l)=>{t.add_module(s,l)},n=(s,l)=>{t.connect(s,l)};C=[];for(let s=0;s<M;s++)C.push({index:s,note:null,active:!1});for(let s=0;s<M;s++)e("vco",`osc_${s}`),e("svf",`filter_${s}`),e("adsr",`env_${s}`),e("vca",`amp_${s}`),e("offset",`pitch_${s}`),e("offset",`gate_${s}`);e("offset","attack_knob"),e("offset","decay_knob"),e("offset","sustain_knob"),e("offset","release_knob"),e("offset","pw_knob"),e("offset","detune_knob"),e("offset","cutoff_knob"),e("offset","resonance_knob"),e("mixer","voice_mixer"),e("chorus","chorus"),e("offset","chorus_rate"),e("offset","chorus_depth"),e("offset","chorus_mix"),e("stereo_output","out");for(let s=0;s<M;s++)n(`pitch_${s}.out`,`osc_${s}.voct`),n(`gate_${s}.out`,`env_${s}.gate`),n("pw_knob.out",`osc_${s}.pw`),n("detune_knob.out",`osc_${s}.fm`),n("attack_knob.out",`env_${s}.attack`),n("decay_knob.out",`env_${s}.decay`),n("sustain_knob.out",`env_${s}.sustain`),n("release_knob.out",`env_${s}.release`),n(`osc_${s}.saw`,`filter_${s}.in`),n(`filter_${s}.lp`,`amp_${s}.in`),n("cutoff_knob.out",`filter_${s}.cutoff`),n("resonance_knob.out",`filter_${s}.res`),n(`env_${s}.env`,`amp_${s}.cv`),n(`amp_${s}.out`,`voice_mixer.ch${s}`);n("voice_mixer.out","chorus.in"),n("chorus_rate.out","chorus.rate"),n("chorus_depth.out","chorus.depth"),n("chorus_mix.out","chorus.mix"),n("chorus.left","out.left"),n("chorus.right","out.right");const r=s=>Math.log10(Math.max(1,s))/4,o=s=>Math.log10(s/20)/3;t.set_param("attack_knob",0,r(10)),t.set_param("decay_knob",0,r(200)),t.set_param("sustain_knob",0,.5),t.set_param("release_knob",0,r(300)),t.set_param("pw_knob",0,.5),t.set_param("detune_knob",0,0),t.set_param("cutoff_knob",0,o(2e3)),t.set_param("resonance_knob",0,.3),t.set_param("chorus_rate",0,.3),t.set_param("chorus_depth",0,.4),t.set_param("chorus_mix",0,.5);for(let s=0;s<M;s++)t.set_param(`pitch_${s}`,0,0),t.set_param(`gate_${s}`,0,0);t.set_output("out"),t.compile(),t.reset();const _=document.getElementById("statModules"),c=document.getElementById("statCables");_&&(_.textContent=String(t.module_count())),c&&(c.textContent=String(t.cable_count()))}function Me(t){const e=t.createScriptProcessor(512,0,2);return e.onaudioprocess=n=>{if(!u||!K){const r=n.outputBuffer.getChannelData(0),o=n.outputBuffer.getChannelData(1);r.fill(0),o.fill(0);return}try{const r=u.process_block(512),o=n.outputBuffer.getChannelData(0),_=n.outputBuffer.getChannelData(1),s=parseFloat(document.getElementById("volume").value)/5/Math.sqrt(M);let l=0,g=0;for(let b=0;b<512;b++){const m=Math.max(-1,Math.min(1,r[b*2]*s)),k=Math.max(-1,Math.min(1,r[b*2+1]*s));o[b]=m,_[b]=k,p[$]=m,se[$]=k,$=($+1)%p.length,l=Math.max(l,Math.abs(m)),g=Math.max(g,Math.abs(k))}N=Math.max(l,N*Y),D=Math.max(g,D*Y)}catch(r){console.error("Audio processing error:",r)}},e}async function $e(){if(!h)try{h=new AudioContext({sampleRate:44100}),h.state==="suspended"&&await h.resume(),y=h.createAnalyser(),y.fftSize=oe,y.smoothingTimeConstant=.8,P=new Uint8Array(y.frequencyBinCount),u=new J(h.sampleRate),qe(u),X=Me(h),X.connect(y),y.connect(h.destination),K=!0,j.textContent="Audio Active",j.disabled=!0,v.className="running",v.textContent=`Active // ${M} Voice Polyphony`,V(L,A),V(T,z),requestAnimationFrame(ce)}catch(t){v.className="error";const e=t instanceof Error?t.message:String(t);v.textContent=`Error: ${e}`,console.error("Failed to start audio:",t)}}function _e(t,e,n){const r=t.createLinearGradient(0,0,e,0);return r.addColorStop(0,"#00f5ff"),r.addColorStop(.5,"#bf00ff"),r.addColorStop(1,"#ff00ff"),r}function Se(t,e,n){t.clearRect(0,0,e,n),t.strokeStyle="rgba(0, 245, 255, 0.1)",t.lineWidth=1;for(let _=0;_<=4;_++){const c=n/4*_;t.beginPath(),t.moveTo(0,c),t.lineTo(e,c),t.stroke()}for(let _=0;_<=8;_++){const c=e/8*_;t.beginPath(),t.moveTo(c,0),t.lineTo(c,n),t.stroke()}t.strokeStyle="rgba(0, 245, 255, 0.3)",t.lineWidth=1,t.beginPath(),t.moveTo(0,n/2),t.lineTo(e,n/2),t.stroke(),t.strokeStyle=_e(t,e),t.lineWidth=2,t.shadowColor="#00f5ff",t.shadowBlur=15,t.beginPath();const r=e/p.length;let o=0;for(let _=0;_<p.length;_++){const s=(1-p[($+_)%p.length])*n/2;_===0?t.moveTo(o,s):t.lineTo(o,s),o+=r}t.stroke(),t.shadowBlur=0}function Ee(t,e,n){t.clearRect(0,0,e,n),t.strokeStyle="rgba(0, 245, 255, 0.2)",t.lineWidth=1,t.beginPath(),t.moveTo(e/2,0),t.lineTo(e/2,n),t.moveTo(0,n/2),t.lineTo(e,n/2),t.stroke(),t.beginPath(),t.arc(e/2,n/2,Math.min(e,n)/2-10,0,Math.PI*2),t.stroke(),t.strokeStyle=_e(t,e),t.lineWidth=2,t.shadowColor="#ff00ff",t.shadowBlur=10,t.beginPath();const r=e/2,o=n/2,_=Math.min(e,n)/2-20;for(let c=0;c<p.length;c++){const s=($+c)%p.length,l=r+p[s]*_,g=o-se[s]*_;c===0?t.moveTo(l,g):t.lineTo(l,g)}t.stroke(),t.shadowBlur=0}function Ae(t,e,n){t.clearRect(0,0,e,n);const r=64,o=e/r-2,_=Math.floor(p.length/r);for(let c=0;c<r;c++){let s=0;for(let k=0;k<_;k++){const ae=($+c*_+k)%p.length;s+=Math.abs(p[ae])}const g=s/_*n*2,b=t.createLinearGradient(0,n,0,n-g);b.addColorStop(0,"#00f5ff"),b.addColorStop(.5,"#bf00ff"),b.addColorStop(1,"#ff00ff"),t.fillStyle=b,t.shadowColor="#00f5ff",t.shadowBlur=8;const m=c*(o+2);t.fillRect(m,n-g,o,g),t.fillStyle="#ffffff",t.fillRect(m,n-g-2,o,2)}t.shadowBlur=0}function Ce(t,e,n){t.clearRect(0,0,e,n),y&&y.getByteFrequencyData(P);const r=P.length,o=e/r;for(let s=0;s<r;s++){const l=P[s]/255,g=l*n,b=180+s/r*120;t.fillStyle=`hsla(${b}, 100%, 60%, 0.8)`;const m=s*o;t.fillRect(m,n-g,o-1,g),l>.1&&(t.fillStyle=`hsla(${b}, 100%, 80%, ${l})`,t.fillRect(m,n-g,o-1,2))}t.fillStyle="rgba(0, 245, 255, 0.5)",t.font="10px JetBrains Mono",t.textAlign="center";const _=["100","1k","5k","10k","20k"],c=[.05,.15,.35,.55,.9];for(let s=0;s<_.length;s++)t.fillText(_[s],e*c[s],n-5)}function Ie(){const t=document.getElementById("vuLeft"),e=document.getElementById("vuRight"),n=document.getElementById("ledsLeft"),r=document.getElementById("ledsRight");t&&(t.style.width=`${Math.min(N*100,100)}%`),e&&(e.style.width=`${Math.min(D*100,100)}%`);const o=(_,c)=>{if(!_)return;const s=_.querySelectorAll(".vu-led"),l=Math.floor(c*s.length);s.forEach((g,b)=>{g.classList.toggle("active",b<l)})};o(n,N),o(r,D)}function Be(){const t=document.getElementById("voiceIndicators");if(!t)return;const e=t.querySelectorAll(".voice-indicator");C.forEach((n,r)=>{e[r]&&e[r].classList.toggle("active",n.active)})}function ce(){if(!K)return;const t=L.getBoundingClientRect(),e=T.getBoundingClientRect();switch(ie){case"scope":Se(A,t.width,t.height);break;case"lissajous":Ee(A,t.width,t.height);break;case"bars":Ae(A,t.width,t.height);break}Ce(z,e.width,e.height),Ie(),Be(),requestAnimationFrame(ce)}function ee(t){if(!u||E.has(t))return;const e=ye(),n=C[e];n.note!==null&&E.delete(n.note),n.note=t,n.active=!0,E.set(t,e);const r=(t-60)/12;u.set_param(`pitch_${e}`,0,r),u.set_param(`gate_${e}`,0,5);const o=document.querySelector(`[data-note="${t}"]`);o&&o.classList.add("active")}function te(t){if(!u)return;const e=E.get(t);if(e===void 0)return;const n=C[e];u.set_param(`gate_${e}`,0,0),n.active=!1,n.note=null,E.delete(t);const r=document.querySelector(`[data-note="${t}"]`);r&&r.classList.remove("active")}function Re(){const t={a:60,w:61,s:62,e:63,d:64,f:65,t:66,g:67,y:68,h:69,u:70,j:71,k:72};document.addEventListener("keydown",n=>{if(n.repeat)return;const r=t[n.key.toLowerCase()];r!==void 0&&ee(r)}),document.addEventListener("keyup",n=>{const r=t[n.key.toLowerCase()];r!==void 0&&te(r)}),document.getElementById("keyboard").addEventListener("mousedown",n=>{const r=n.target.closest(".key");if(r){const o=parseInt(r.getAttribute("data-note"));ee(o)}}),document.addEventListener("mouseup",()=>{for(const[n]of E)te(n)})}function Fe(){const t=document.querySelectorAll(".viz-mode-btn");t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(n=>n.classList.remove("active")),e.classList.add("active"),ie=e.getAttribute("data-mode")})})}function Le(t,e){switch(t){case"pulseWidth":return`${Math.round(e*100)}%`;case"detune":return`${e>0?"+":""}${Math.round(e)}ct`;case"cutoff":return e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`;case"resonance":return`${Math.round(e*100)}%`;case"filterEnv":return e>=1e3?`${(e/1e3).toFixed(1)}k`:`${Math.round(e)}`;case"attack":case"decay":case"release":return`${Math.round(e)}ms`;case"sustain":return`${Math.round(e*100)}%`;case"volume":return`${Math.round(e*100)}%`;case"chorusRate":return`${e.toFixed(1)}Hz`;case"chorusDepth":case"chorusMix":return`${Math.round(e*100)}%`;default:return String(e)}}function Te(){const t=(o,_)=>{const c=document.getElementById(o),s=document.getElementById(o+"Value"),l=()=>{const g=parseFloat(c.value);s&&(s.textContent=Le(o,g)),_(g)};c.addEventListener("input",l),l()};t("volume",()=>{});const e=document.getElementById("waveform");e.addEventListener("change",()=>{ve(e.value)});const n=o=>Math.log10(Math.max(1,o))/4,r=o=>Math.log10(o/20)/3;t("attack",o=>{u&&u.set_param("attack_knob",0,n(o))}),t("decay",o=>{u&&u.set_param("decay_knob",0,n(o))}),t("sustain",o=>{u&&u.set_param("sustain_knob",0,o)}),t("release",o=>{u&&u.set_param("release_knob",0,n(o))}),t("pulseWidth",o=>{u&&u.set_param("pw_knob",0,o)}),t("detune",o=>{const _=o/1200;u&&u.set_param("detune_knob",0,_)}),t("cutoff",o=>{u&&u.set_param("cutoff_knob",0,r(o))}),t("resonance",o=>{u&&u.set_param("resonance_knob",0,o)}),t("filterEnv",()=>{}),t("chorusRate",o=>{u&&u.set_param("chorus_rate",0,o)}),t("chorusDepth",o=>{const _=Math.min(o,.8);u&&u.set_param("chorus_depth",0,_)}),t("chorusMix",o=>{u&&u.set_param("chorus_mix",0,o)})}function ne(){L&&A&&V(L,A),T&&z&&V(T,z)}async function Oe(){console.log("Initializing Quiver Browser Synth..."),await ke(),Re(),Fe(),Te(),j.addEventListener("click",$e),window.addEventListener("resize",ne),ne()}Oe();
