#!/bin/sh
# Pre-commit hook for Quiver
# Runs format check and linting before allowing commits

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Get staged Rust files
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -z "$STAGED_RS_FILES" ]; then
    echo "${GREEN}No Rust files staged, skipping Rust checks${NC}"
    exit 0
fi

# Check formatting
echo "Checking code formatting..."
if ! cargo fmt --all -- --check > /dev/null 2>&1; then
    echo "${RED}Format check failed!${NC}"
    echo "${YELLOW}Run 'cargo fmt' to fix formatting issues${NC}"
    echo ""
    echo "Showing formatting differences:"
    cargo fmt --all -- --check 2>&1 | head -20
    exit 1
fi
echo "${GREEN}✓ Formatting OK${NC}"

# Run clippy on staged files
echo "Running clippy..."
if ! cargo clippy --all-features -- -D warnings > /dev/null 2>&1; then
    echo "${RED}Clippy check failed!${NC}"
    echo "${YELLOW}Fix the following issues:${NC}"
    echo ""
    cargo clippy --all-features -- -D warnings 2>&1 | grep -E "^error|^warning" | head -20
    exit 1
fi
echo "${GREEN}✓ Clippy OK${NC}"

# Optional: Run quick tests
# Uncomment the following to also run tests before committing
# echo "Running quick tests..."
# if ! cargo test --lib --quiet > /dev/null 2>&1; then
#     echo "${RED}Tests failed!${NC}"
#     echo "${YELLOW}Run 'cargo test' to see failures${NC}"
#     exit 1
# fi
# echo "${GREEN}✓ Tests OK${NC}"

echo ""
echo "${GREEN}All pre-commit checks passed!${NC}"
exit 0
